name: OpenTelemetry-Supervised-Collector
permissions:
  contents: read

on:
  push:
    branches:
      - master
    paths:
    - 'otel-supervised-collector/CURRENT_VERSION'

jobs:
  trigger-release:
    permissions:
      actions: write
      contents: read
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for version change
        id: check
        run: |
          BEFORE_SHA="${{ github.event.before }}"

          # If for some reason BEFORE_SHA is empty (e.g. new branch), default to true
          if [ -z "$BEFORE_SHA" ] || [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
             echo "New branch or unknown state, assuming change."
             echo "changed=true" >> "$GITHUB_OUTPUT"
             exit 0
          fi

          echo "Fetching previous commit $BEFORE_SHA..."
          git fetch origin "$BEFORE_SHA" --depth=1

          echo "Comparing versions between $BEFORE_SHA and HEAD"

          # Get previous version
          git show "$BEFORE_SHA":otel-supervised-collector/CURRENT_VERSION > old_ver 2>/dev/null || echo "" > old_ver

          # Get current version
          cat otel-supervised-collector/CURRENT_VERSION > new_ver

          # Compare stripping all whitespace
          OLD=$(tr -d '[:space:]' < old_ver)
          NEW=$(tr -d '[:space:]' < new_ver)

          if [ "$OLD" != "$NEW" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Version changed from '$OLD' to '$NEW'"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No version change detected (ignoring whitespace)"
          fi

      - name: Trigger Release workflow (CGX JFrog)
        if: steps.check.outputs.changed == 'true'
        run: |
          gh workflow run otel-supervised-collector-release.yml \
           --ref master \
           -f push_image=true \
           -f registry_org=cgx.jfrog.io/coralogix-docker-images
      - name: Trigger Release workflow (Docker Hub)
        if: steps.check.outputs.changed == 'true'
        run: |
          gh workflow run otel-supervised-collector-release.yml \
           --ref master \
           -f push_image=true \
           -f registry_org=docker.io/coralogixrepo
