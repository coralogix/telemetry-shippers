name: Sync Fleet Manager OTEL Integration changelog

on:
  push:
    branches:
      - master
    paths:
      - otel-integration/CHANGELOG.md
      - otel-linux-standalone/CHANGELOG.md
      - otel-macos-standalone/CHANGELOG.md
      - otel-windows-standalone/CHANGELOG.md
  workflow_dispatch:
    inputs:
      fleet_manager_repo:
        description: "Fleet Manager repo in owner/repo format"
        type: string
        default: "coralogix/fleet-manager"
        required: false
      fleet_manager_ref:
        description: "Fleet Manager ref (branch/tag/SHA)"
        type: string
        default: "master"
        required: false
      create_pr:
        description: "If true, create branch/commit/push and open PR in Fleet Manager"
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  sync-fleet-manager-otel-integration-changelog:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'

    - name: Validate changelog format
      run: |
        go run ./cmd/helmlog validate \
          otel-integration/CHANGELOG.md \
          otel-linux-standalone/CHANGELOG.md \
          otel-macos-standalone/CHANGELOG.md \
          otel-windows-standalone/CHANGELOG.md

    - name: Generate changelog artifacts (json)
      run: |
        set -euo pipefail

        go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel-integration_changelog.json" otel-integration/CHANGELOG.md
        go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel-linux-standalone_changelog.json" otel-linux-standalone/CHANGELOG.md
        go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel-macos-standalone_changelog.json" otel-macos-standalone/CHANGELOG.md
        go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel-windows-standalone_changelog.json" otel-windows-standalone/CHANGELOG.md

    - name: Checkout Fleet Manager
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.fleet_manager_repo || 'coralogix/fleet-manager' }}
        ref: ${{ inputs.fleet_manager_ref || 'master' }}
        path: fleet-manager
        fetch-depth: 0
        token: ${{ secrets.GH_TOKEN }}

    - name: Copy artifacts when changed
      id: update_file
      run: |
        set -euo pipefail
        mappings=(
          "otel-integration_changelog.json:pkg/helm/data/otel-integration_changelog.json"
          "otel-linux-standalone_changelog.json:pkg/helm/data/otel-linux-standalone_changelog.json"
          "otel-macos-standalone_changelog.json:pkg/helm/data/otel-macos-standalone_changelog.json"
          "otel-windows-standalone_changelog.json:pkg/helm/data/otel-windows-standalone_changelog.json"
        )

        changed_files=()

        for mapping in "${mappings[@]}"; do
          src_name="${mapping%%:*}"
          dst_name="${mapping##*:}"
          src="$RUNNER_TEMP/$src_name"
          dst="$GITHUB_WORKSPACE/fleet-manager/$dst_name"

          if [ -f "$dst" ] && cmp -s "$src" "$dst"; then
            continue
          fi

          mkdir -p "$(dirname "$dst")"
          cp "$src" "$dst"
          changed_files+=("$dst_name")
        done

        if [ "${#changed_files[@]}" -eq 0 ]; then
          echo "No changelog updates to sync."
          echo "updated=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "updated=true" >> "$GITHUB_OUTPUT"
        printf 'changed_files=%s\n' "${changed_files[*]}" >> "$GITHUB_OUTPUT"

    - name: Create or update Fleet Manager PR
      if: steps.update_file.outputs.updated == 'true'
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        CREATE_PR: ${{ github.event_name != 'workflow_dispatch' || inputs.create_pr }}
        FLEET_MANAGER_REPO: ${{ inputs.fleet_manager_repo || 'coralogix/fleet-manager' }}
        FLEET_MANAGER_REF: ${{ inputs.fleet_manager_ref || 'master' }}
      run: |
        set -euo pipefail

        if [ -z "${GH_TOKEN:-}" ]; then
          echo "Missing GH_TOKEN secret"
          exit 1
        fi

        repo_dir="$GITHUB_WORKSPACE/fleet-manager"
        branch="bot/sync-otel-integration-changelog"

        if [ "${CREATE_PR:-false}" != "true" ]; then
          echo "CREATE_PR is false; skipping branch/commit/push/PR. (Dry run complete.)"
          echo ""
          echo "Changed files in Fleet Manager:"
          git -C "$repo_dir" --no-pager diff --stat
          echo ""
          echo "Full diff:"
          git -C "$repo_dir" --no-pager diff
          exit 0
        fi

        git -C "$repo_dir" config user.name "github-actions[bot]"
        git -C "$repo_dir" config user.email "github-actions[bot]@users.noreply.github.com"

        read -r -a changed_files <<< "${{ steps.update_file.outputs.changed_files }}"

        if git -C "$repo_dir" ls-remote --exit-code --heads origin "$branch" >/dev/null 2>&1; then
          for dst_name in "${changed_files[@]}"; do
            if git -C "$repo_dir" ls-files --error-unmatch "$dst_name" >/dev/null 2>&1; then
              git -C "$repo_dir" checkout -- "$dst_name"
            else
              rm -f "$repo_dir/$dst_name"
            fi
          done
          git -C "$repo_dir" fetch origin "$branch"
          git -C "$repo_dir" checkout "$branch"
          git -C "$repo_dir" rebase "origin/$FLEET_MANAGER_REF"
        else
          git -C "$repo_dir" checkout -b "$branch"
        fi

        for dst_name in "${changed_files[@]}"; do
          cp "$RUNNER_TEMP/$(basename "$dst_name")" "$repo_dir/$dst_name"
        done

        git -C "$repo_dir" add "${changed_files[@]}"
        if git -C "$repo_dir" diff --cached --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        git -C "$repo_dir" commit -m "Update OTEL changelog artifacts"
        git -C "$repo_dir" push origin "$branch"

        existing_pr="$(gh pr list -R "$FLEET_MANAGER_REPO" --head "$branch" --state open --json number --jq '.[0].number')"
        if [ -n "$existing_pr" ]; then
          echo "PR already exists: #$existing_pr"
          exit 0
        fi

        gh pr create \
          -R "$FLEET_MANAGER_REPO" \
          --base "$FLEET_MANAGER_REF" \
          --head "$branch" \
          --title "Update OTEL changelog artifacts" \
          --body "Automated update of OTEL changelog JSON artifacts generated from telemetry-shippers changelog sources."
