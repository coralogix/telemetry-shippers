name: Sync Fleet Manager artifacts

on:
  push:
    branches:
      - master
    paths:
      - otel-integration/k8s-helm/Chart.yaml
      - otel-integration/CHANGELOG.md
      - otel-linux-standalone/CHANGELOG.md
      - otel-macos-standalone/CHANGELOG.md
      - otel-windows-standalone/CHANGELOG.md
  workflow_dispatch:
    inputs:
      force:
        description: "Run map sync even if no version bump is detected"
        type: boolean
        default: false
      integration_chart_version:
        description: "Override otel-integration chart version (e.g. 0.0.268)"
        type: string
        required: false
      collector_chart_version:
        description: "Override opentelemetry-collector chart version (e.g. 0.128.15)"
        type: string
        required: false
      app_version:
        description: "Override collector appVersion (skips helm lookup)"
        type: string
        required: false
      fleet_manager_repo:
        description: "Fleet Manager repo in owner/repo format"
        type: string
        default: "coralogix/fleet-manager"
        required: false
      fleet_manager_ref:
        description: "Fleet Manager ref (branch/tag/SHA)"
        type: string
        default: "master"
        required: false
      create_pr:
        description: "If true, create commit/push and open PR in Fleet Manager"
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  sync-fleet-manager:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout telemetry-shippers
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq and jq
        run: sudo apt-get update && sudo apt-get install -y yq jq

      - name: Detect otel-integration chart version bump
        id: detect
        run: |
          set -euo pipefail
          file="otel-integration/k8s-helm/Chart.yaml"

          integration_chart_version="${INTEGRATION_CHART_VERSION_OVERRIDE:-}"
          if [ -z "$integration_chart_version" ]; then
            integration_chart_version="$(scripts/resolve-integration-chart-version.sh "$file")"
          fi

          old_integration_chart_version=""
          base_sha="${GITHUB_EVENT_BEFORE:-}"
          if [ -n "$base_sha" ] && [ "$base_sha" != "0000000000000000000000000000000000000000" ]; then
            if git cat-file -e "$base_sha^{commit}" 2>/dev/null; then
              old_file="$(mktemp)"
              if git show "$base_sha:$file" > "$old_file" 2>/dev/null; then
                old_integration_chart_version="$(yq -r '.version' "$old_file")"
              fi
              rm -f "$old_file"
            fi
          fi

          if [ -z "$old_integration_chart_version" ]; then
            old_file="$(mktemp)"
            if git show "HEAD^1:$file" > "$old_file" 2>/dev/null; then
              old_integration_chart_version="$(yq -r '.version' "$old_file")"
            fi
            rm -f "$old_file"
          fi

          collector_chart_version="${COLLECTOR_CHART_VERSION_OVERRIDE:-}"
          if [ -z "$collector_chart_version" ]; then
            collector_chart_version="$(scripts/resolve-collector-chart-version.sh "$file")"
          fi

          app_version="${APP_VERSION_OVERRIDE:-}"

          echo "integration_chart_version=$integration_chart_version" >> "$GITHUB_OUTPUT"
          echo "old_integration_chart_version=$old_integration_chart_version" >> "$GITHUB_OUTPUT"
          echo "collector_chart_version=$collector_chart_version" >> "$GITHUB_OUTPUT"
          echo "app_version=$app_version" >> "$GITHUB_OUTPUT"

          bumped="false"
          if [ "${FORCE_RUN:-false}" = "true" ]; then
            bumped="true"
          elif [ -n "$old_integration_chart_version" ] && [ "$integration_chart_version" != "$old_integration_chart_version" ]; then
            bumped="true"
          fi

          echo "bumped=$bumped" >> "$GITHUB_OUTPUT"
        env:
          FORCE_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.force }}
          INTEGRATION_CHART_VERSION_OVERRIDE: ${{ (github.event_name == 'workflow_dispatch' && inputs.integration_chart_version) || '' }}
          COLLECTOR_CHART_VERSION_OVERRIDE: ${{ (github.event_name == 'workflow_dispatch' && inputs.collector_chart_version) || '' }}
          APP_VERSION_OVERRIDE: ${{ (github.event_name == 'workflow_dispatch' && inputs.app_version) || '' }}
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}

      - uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'

      - name: Validate changelog format
        run: |
          go run ./cmd/helmlog validate \
            otel-integration/CHANGELOG.md \
            otel-linux-standalone/CHANGELOG.md \
            otel-macos-standalone/CHANGELOG.md \
            otel-windows-standalone/CHANGELOG.md

      - name: Generate changelog artifacts (json)
        run: |
          set -euo pipefail
          go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel_integration_changelog.json" otel-integration/CHANGELOG.md
          go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel_linux_standalone_changelog.json" otel-linux-standalone/CHANGELOG.md
          go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel_macos_standalone_changelog.json" otel-macos-standalone/CHANGELOG.md
          go run ./cmd/helmlog generate --output "$RUNNER_TEMP/otel_windows_standalone_changelog.json" otel-windows-standalone/CHANGELOG.md

      - name: Set up Helm
        if: steps.detect.outputs.bumped == 'true'
        uses: azure/setup-helm@v4

      - name: Checkout Fleet Manager
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.fleet_manager_repo || 'coralogix/fleet-manager' }}
          ref: ${{ inputs.fleet_manager_ref || 'master' }}
          path: fleet-manager
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Prepare Fleet Manager branch
        env:
          FLEET_MANAGER_REF: ${{ inputs.fleet_manager_ref || 'master' }}
        run: |
          set -euo pipefail
          repo_dir="$GITHUB_WORKSPACE/fleet-manager"
          branch="bot/sync-fleet-manager-artifacts"

          git -C "$repo_dir" config user.name "github-actions[bot]"
          git -C "$repo_dir" config user.email "github-actions[bot]@users.noreply.github.com"

          if git -C "$repo_dir" ls-remote --exit-code --heads origin "$branch" >/dev/null 2>&1; then
            git -C "$repo_dir" fetch origin "$branch"
            git -C "$repo_dir" checkout "$branch"
            git -C "$repo_dir" rebase "origin/$FLEET_MANAGER_REF"
          else
            git -C "$repo_dir" checkout -b "$branch"
          fi

      - name: Update Fleet Manager collector chart mapping
        id: update_map
        if: steps.detect.outputs.bumped == 'true'
        env:
          INTEGRATION_CHART_VERSION: ${{ steps.detect.outputs.integration_chart_version }}
          COLLECTOR_CHART_VERSION: ${{ steps.detect.outputs.collector_chart_version }}
          APP_VERSION_OVERRIDE: ${{ steps.detect.outputs.app_version }}
        run: |
          set -euo pipefail

          output_env="$RUNNER_TEMP/fleet-manager-output.env"
          args=(
            --chart-file otel-integration/k8s-helm/Chart.yaml
            --fleet-manager-dir "$GITHUB_WORKSPACE/fleet-manager"
            --output-env "$output_env"
            --integration-chart-version "$INTEGRATION_CHART_VERSION"
            --chart-version "$COLLECTOR_CHART_VERSION"
          )
          if [ -n "${APP_VERSION_OVERRIDE:-}" ]; then
            args+=(--app-version "$APP_VERSION_OVERRIDE")
          fi
          scripts/update-fleet-manager-collector-chart-map.sh "${args[@]}"

          set -a
          . "$output_env"
          set +a

          if [ "${MAPPING_UPDATED:-false}" = "true" ]; then
            echo "updated=true" >> "$GITHUB_OUTPUT"
            echo "changed_files=pkg/helm/data/collector_chart_versions_map.json pkg/helm/data/otel_integration_chart_versions_map.json" >> "$GITHUB_OUTPUT"
          else
            echo "updated=false" >> "$GITHUB_OUTPUT"
            echo "changed_files=" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy changelog artifacts when changed
        id: update_changelog
        run: |
          set -euo pipefail
          mappings=(
            "otel_integration_changelog.json:pkg/helm/data/otel_integration_changelog.json"
            "otel_linux_standalone_changelog.json:pkg/helm/data/otel_linux_standalone_changelog.json"
            "otel_macos_standalone_changelog.json:pkg/helm/data/otel_macos_standalone_changelog.json"
            "otel_windows_standalone_changelog.json:pkg/helm/data/otel_windows_standalone_changelog.json"
          )

          changed_files=()
          for mapping in "${mappings[@]}"; do
            src_name="${mapping%%:*}"
            dst_name="${mapping##*:}"
            src="$RUNNER_TEMP/$src_name"
            dst="$GITHUB_WORKSPACE/fleet-manager/$dst_name"

            if [ -f "$dst" ] && cmp -s "$src" "$dst"; then
              continue
            fi

            mkdir -p "$(dirname "$dst")"
            cp "$src" "$dst"
            changed_files+=("$dst_name")
          done

          if [ "${#changed_files[@]}" -eq 0 ]; then
            echo "updated=false" >> "$GITHUB_OUTPUT"
            echo "changed_files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "updated=true" >> "$GITHUB_OUTPUT"
          printf 'changed_files=%s\n' "${changed_files[*]}" >> "$GITHUB_OUTPUT"

      - name: Commit, push, and create/update PR
        if: steps.update_map.outputs.updated == 'true' || steps.update_changelog.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CREATE_PR: ${{ github.event_name != 'workflow_dispatch' || inputs.create_pr }}
          FLEET_MANAGER_REPO: ${{ inputs.fleet_manager_repo || 'coralogix/fleet-manager' }}
          FLEET_MANAGER_REF: ${{ inputs.fleet_manager_ref || 'master' }}
          INTEGRATION_CHART_VERSION: ${{ steps.detect.outputs.integration_chart_version }}
          COLLECTOR_CHART_VERSION: ${{ steps.detect.outputs.collector_chart_version }}
        run: |
          set -euo pipefail

          repo_dir="$GITHUB_WORKSPACE/fleet-manager"
          branch="bot/sync-fleet-manager-artifacts"

          map_files="${{ steps.update_map.outputs.changed_files }}"
          changelog_files="${{ steps.update_changelog.outputs.changed_files }}"
          map_updated="${{ steps.update_map.outputs.updated }}"
          changelog_updated="${{ steps.update_changelog.outputs.updated }}"

          declare -A file_set=()
          read -r -a map_list <<< "$map_files"
          read -r -a changelog_list <<< "$changelog_files"
          for file in "${map_list[@]}"; do
            [ -n "$file" ] && file_set["$file"]=1
          done
          for file in "${changelog_list[@]}"; do
            [ -n "$file" ] && file_set["$file"]=1
          done

          files=()
          for file in "${!file_set[@]}"; do
            files+=("$file")
          done

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No files to stage."
            exit 0
          fi

          git -C "$repo_dir" add "${files[@]}"
          if git -C "$repo_dir" diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          if [ "${CREATE_PR:-false}" != "true" ]; then
            echo "CREATE_PR is false; skipping commit/push/PR. (Dry run complete.)"
            echo ""
            echo "Changed files in Fleet Manager:"
            git -C "$repo_dir" --no-pager diff --cached --stat
            echo ""
            echo "Full staged diff:"
            git -C "$repo_dir" --no-pager diff --cached
            exit 0
          fi

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "Missing GH_TOKEN secret"
            exit 1
          fi

          git -C "$repo_dir" commit -m "Sync Fleet Manager artifacts from telemetry-shippers"
          git -C "$repo_dir" push -u origin "$branch"

          existing_pr="$(gh pr list -R "$FLEET_MANAGER_REPO" --head "$branch" --state open --json number --jq '.[0].number')"
          if [ -n "$existing_pr" ]; then
            echo "PR already exists: #$existing_pr"
            exit 0
          fi

          pr_body="$RUNNER_TEMP/fleet-manager-sync-pr-body.md"
          {
            echo "Automated synchronization from telemetry-shippers."
            echo ""
            if [ "$map_updated" = "true" ]; then
              echo "## Collector chart map"
              printf -- '- otel-integration chart: `%s`\n' "$INTEGRATION_CHART_VERSION"
              printf -- '- opentelemetry-collector chart: `%s`\n' "$COLLECTOR_CHART_VERSION"
              echo ""
            fi
            if [ "$changelog_updated" = "true" ]; then
              echo "## OTEL changelog artifacts"
              echo '- Updated changelog JSON artifacts under `pkg/helm/data`.'
              echo ""
            fi
          } > "$pr_body"

          gh pr create \
            -R "$FLEET_MANAGER_REPO" \
            --base "$FLEET_MANAGER_REF" \
            --head "$branch" \
            --title "Sync Fleet Manager artifacts from telemetry-shippers" \
            --body-file "$pr_body"
