name: E2E Otel Installer Tests

on:
  pull_request:
    paths:
      - 'otel-installer/**'
  workflow_dispatch:

permissions:
  contents: read

env:
  CORALOGIX_PRIVATE_KEY: "test-key-12345"
  CORALOGIX_DOMAIN: "us1.coralogix.com"

jobs:
  #############################################
  # Standalone Script Tests
  #############################################

  standalone-linux-install:
    name: Standalone - Linux Install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install (default)
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh
        
      - name: Verify service running
        run: sudo systemctl is-active otelcol-contrib
        
      - name: Verify health check
        run: curl -sf http://127.0.0.1:13133/ || true
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  standalone-linux-version:
    name: Standalone - Linux Specific Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install specific version
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh -v 0.140.1
        
      - name: Verify version
        run: /usr/bin/otelcol-contrib --version | grep "0.140.1"
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  standalone-linux-config:
    name: Standalone - Linux Custom Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create test config with unique marker
        run: |
          printf '%s\n' \
            '# CUSTOM_CONFIG_MARKER_E2E_TEST' \
            'receivers:' \
            '  otlp:' \
            '    protocols:' \
            '      grpc:' \
            '        endpoint: 0.0.0.0:4317' \
            'exporters:' \
            '  debug:' \
            '    verbosity: basic' \
            'extensions:' \
            '  health_check:' \
            '    endpoint: 127.0.0.1:13133' \
            'service:' \
            '  extensions: [health_check]' \
            '  pipelines:' \
            '    logs:' \
            '      receivers: [otlp]' \
            '      exporters: [debug]' \
            > /tmp/test-config.yaml
          
      - name: Install with custom config
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh -c /tmp/test-config.yaml
        
      - name: Verify custom config loaded
        run: |
          sudo cat /etc/otelcol-contrib/config.yaml
          sudo grep "CUSTOM_CONFIG_MARKER_E2E_TEST" /etc/otelcol-contrib/config.yaml
          sudo grep "otlp:" /etc/otelcol-contrib/config.yaml
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  standalone-linux-upgrade-with-config:
    name: Standalone - Linux Upgrade with New Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install (default version with default config)
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh
        
      - name: Verify default config exists
        run: |
          sudo cat /etc/otelcol-contrib/config.yaml
          # Package default has otlp receiver
          sudo grep "otlp:" /etc/otelcol-contrib/config.yaml
        
      - name: Create new custom config with marker
        run: |
          printf '%s\n' \
            '# UPGRADED_CONFIG_MARKER_E2E_TEST' \
            'receivers:' \
            '  otlp:' \
            '    protocols:' \
            '      grpc:' \
            '        endpoint: 0.0.0.0:4317' \
            'exporters:' \
            '  debug:' \
            '    verbosity: detailed' \
            'extensions:' \
            '  health_check:' \
            '    endpoint: 127.0.0.1:13133' \
            'service:' \
            '  extensions: [health_check]' \
            '  pipelines:' \
            '    logs:' \
            '      receivers: [otlp]' \
            '      exporters: [debug]' \
            > /tmp/new-config.yaml
        
      - name: Upgrade with new config (auto-detects and replaces)
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh -c /tmp/new-config.yaml
        
      - name: Verify new config loaded
        run: |
          sudo cat /etc/otelcol-contrib/config.yaml
          sudo grep "UPGRADED_CONFIG_MARKER_E2E_TEST" /etc/otelcol-contrib/config.yaml
          sudo grep "verbosity: detailed" /etc/otelcol-contrib/config.yaml
        
      - name: Verify service still running
        run: sudo systemctl is-active otelcol-contrib
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  standalone-linux-supervisor:
    name: Standalone - Linux Supervisor Mode
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install supervisor mode
        run: sudo CORALOGIX_DOMAIN="${CORALOGIX_DOMAIN}" CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh -s
        
      - name: Verify supervisor running
        run: sudo systemctl is-active opampsupervisor
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  standalone-linux-supervisor-versions:
    name: Standalone - Linux Supervisor Custom Versions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install with custom versions
        run: |
          sudo CORALOGIX_DOMAIN="${CORALOGIX_DOMAIN}" CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" \
            bash ./otel-installer/standalone/coralogix-otel-collector.sh -s \
            --supervisor-version 0.140.0 --collector-version 0.140.0
        
      - name: Verify supervisor running
        run: sudo systemctl is-active opampsupervisor
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  standalone-linux-purge:
    name: Standalone - Linux Uninstall with Purge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh
        
      - name: Uninstall with purge
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall --purge
        
      - name: Verify config removed
        run: |
          if [ -f /etc/otelcol-contrib/config.yaml ]; then
            echo "Config still exists!" && exit 1
          fi

  standalone-macos:
    name: Standalone - macOS LaunchDaemon
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install
        run: sudo CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/standalone/coralogix-otel-collector.sh
        
      - name: Verify binary installed
        run: /usr/local/bin/otelcol-contrib --version
        
      - name: Verify service registered
        run: sudo launchctl list | grep otelcol || true
        
      - name: Uninstall
        run: sudo bash ./otel-installer/standalone/coralogix-otel-collector.sh --uninstall

  # Note: LaunchAgent tests are skipped in CI because GitHub Actions runners
  # don't have GUI sessions. LaunchAgent requires user login context.
  # The LaunchDaemon test above covers macOS functionality.

  #############################################
  # Docker Script Tests
  #############################################

  docker-install:
    name: Docker - Regular Install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install
        run: CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/docker/docker-install.sh
        
      - name: Verify container running
        run: |
          sleep 3
          docker ps | grep coralogix-otel-collector
          
      - name: Uninstall
        run: bash ./otel-installer/docker/docker-install.sh --uninstall

  docker-version:
    name: Docker - Specific Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install specific version
        run: CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/docker/docker-install.sh -v 0.140.0
        
      - name: Verify container running
        run: |
          sleep 3
          docker ps | grep coralogix-otel-collector
          
      - name: Uninstall
        run: bash ./otel-installer/docker/docker-install.sh --uninstall

  docker-config:
    name: Docker - Custom Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create test config with unique marker
        run: |
          printf '%s\n' \
            '# CUSTOM_CONFIG_MARKER_E2E_TEST' \
            'receivers:' \
            '  otlp:' \
            '    protocols:' \
            '      grpc:' \
            '        endpoint: 0.0.0.0:4317' \
            'exporters:' \
            '  debug:' \
            '    verbosity: basic' \
            'extensions:' \
            '  health_check:' \
            '    endpoint: 0.0.0.0:13133' \
            'service:' \
            '  extensions: [health_check]' \
            '  pipelines:' \
            '    logs:' \
            '      receivers: [otlp]' \
            '      exporters: [debug]' \
            > /tmp/test-config.yaml
          
      - name: Show test config
        run: cat /tmp/test-config.yaml
          
      - name: Install with custom config
        run: CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/docker/docker-install.sh -c /tmp/test-config.yaml
        
      - name: Verify container running
        run: |
          sleep 5
          docker ps -a | grep coralogix-otel-collector
          
      - name: Show container logs
        if: always()
        run: docker logs coralogix-otel-collector 2>&1 | tail -30
          
      - name: Verify custom config loaded
        run: |
          docker cp coralogix-otel-collector:/etc/otelcol-contrib/config.yaml /tmp/container-config.yaml
          cat /tmp/container-config.yaml
          grep "CUSTOM_CONFIG_MARKER" /tmp/container-config.yaml
          
      - name: Verify health check
        run: curl -sf http://localhost:13133/ || true
          
      - name: Uninstall
        run: bash ./otel-installer/docker/docker-install.sh --uninstall

  docker-supervisor:
    name: Docker - Supervisor Mode
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install supervisor mode
        run: CORALOGIX_DOMAIN="${CORALOGIX_DOMAIN}" CORALOGIX_PRIVATE_KEY="${CORALOGIX_PRIVATE_KEY}" bash ./otel-installer/docker/docker-install.sh -s
        
      - name: Verify container running
        run: |
          sleep 5
          docker ps | grep coralogix-otel-collector
          
      - name: View logs
        if: always()
        run: docker logs coralogix-otel-collector 2>&1 | tail -20
          
      - name: Uninstall
        run: bash ./otel-installer/docker/docker-install.sh --uninstall

  #############################################
  # Windows Script Tests
  #############################################

  standalone-windows-install:
    name: Standalone - Windows Install
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install (default)
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1
        
      - name: Verify service running
        shell: pwsh
        run: |
          if ((Get-Service -Name "otelcol-contrib").Status -ne 'Running') { exit 1 }
        
      - name: Uninstall
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall

  standalone-windows-version:
    name: Standalone - Windows Specific Version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install specific version
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1 -Version 0.140.1
        
      - name: Verify version
        shell: pwsh
        run: |
          & "${env:ProgramFiles}\OpenTelemetry Collector\otelcol-contrib.exe" --version | Select-String "0.140.1"
        
      - name: Uninstall
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall

  standalone-windows-config:
    name: Standalone - Windows Custom Config
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create test config with unique marker
        shell: pwsh
        run: |
          @"
          # CUSTOM_CONFIG_MARKER_E2E_TEST
          receivers:
            otlp:
              protocols:
                grpc:
                  endpoint: 0.0.0.0:4317
          exporters:
            debug:
              verbosity: basic
          extensions:
            health_check:
              endpoint: 127.0.0.1:13133
          service:
            extensions: [health_check]
            pipelines:
              logs:
                receivers: [otlp]
                exporters: [debug]
          "@ | Out-File -FilePath "$env:TEMP\test-config.yaml" -Encoding utf8
          
      - name: Install with custom config
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1 -Config "$env:TEMP\test-config.yaml"
        
      - name: Verify custom config loaded
        shell: pwsh
        run: |
          Get-Content "${env:ProgramData}\OpenTelemetry\Collector\config.yaml"
          Select-String -Path "${env:ProgramData}\OpenTelemetry\Collector\config.yaml" -Pattern "CUSTOM_CONFIG_MARKER_E2E_TEST"
          Select-String -Path "${env:ProgramData}\OpenTelemetry\Collector\config.yaml" -Pattern "otlp:"
        
      - name: Uninstall
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall

  standalone-windows-upgrade:
    name: Standalone - Windows Upgrade
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install (default version)
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1
        
      - name: Verify service running
        shell: pwsh
        run: |
          if ((Get-Service -Name "otelcol-contrib").Status -ne 'Running') { exit 1 }
        
      - name: Get installed version
        shell: pwsh
        run: |
          & "${env:ProgramFiles}\OpenTelemetry Collector\otelcol-contrib.exe" --version
        
      - name: Run upgrade (same version - tests upgrade mechanism)
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1 -Upgrade
        
      - name: Verify service still running after upgrade
        shell: pwsh
        run: |
          if ((Get-Service -Name "otelcol-contrib").Status -ne 'Running') { exit 1 }
        
      - name: Uninstall
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall

  standalone-windows-supervisor:
    name: Standalone - Windows Supervisor Mode
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install supervisor mode
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          $env:CORALOGIX_DOMAIN = "${{ env.CORALOGIX_DOMAIN }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1 -Supervisor
        
      - name: Verify supervisor running
        shell: pwsh
        run: |
          if ((Get-Service -Name "opampsupervisor").Status -ne 'Running') { exit 1 }
        
      - name: Uninstall
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall

  standalone-windows-supervisor-versions:
    name: Standalone - Windows Supervisor Custom Versions
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install with custom versions
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          $env:CORALOGIX_DOMAIN = "${{ env.CORALOGIX_DOMAIN }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1 -Supervisor -SupervisorVersion 0.140.0 -CollectorVersion 0.140.0
        
      - name: Verify supervisor running
        shell: pwsh
        run: |
          if ((Get-Service -Name "opampsupervisor").Status -ne 'Running') { exit 1 }
        
      - name: Uninstall
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall

  standalone-windows-purge:
    name: Standalone - Windows Uninstall with Purge
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install
        shell: pwsh
        run: |
          $env:CORALOGIX_PRIVATE_KEY = "${{ env.CORALOGIX_PRIVATE_KEY }}"
          .\otel-installer\windows\coralogix-otel-collector.ps1
        
      - name: Uninstall with purge
        shell: pwsh
        run: .\otel-installer\windows\coralogix-otel-collector.ps1 -Uninstall -Purge
        
      - name: Verify config removed
        shell: pwsh
        run: |
          if (Test-Path "${env:ProgramData}\OpenTelemetry\Collector\config.yaml") {
            Write-Host "Config still exists!" ; exit 1
          }