command:
  name: "otelcol-contrib"

replicaCount: 1
config:
  exporters:
    coralogix:
      application_name: otel
      application_name_attributes:
        - k8s.namespace.name
        - service.namespace
      domain: app.staging.coralogix.net
      logs:
        headers:
          X-Coralogix-Distribution: helm-otel-integration/0.0.224
      metrics:
        headers:
          X-Coralogix-Distribution: helm-otel-integration/0.0.224
      private_key: ${env:CORALOGIX_PRIVATE_KEY}
      profiles:
        headers:
          X-Coralogix-Distribution: helm-otel-integration/0.0.224
      subsystem_name: integration
      subsystem_name_attributes:
        - k8s.deployment.name
        - k8s.statefulset.name
        - k8s.daemonset.name
        - k8s.cronjob.name
        - service.name
      timeout: 30s
      traces:
        headers:
          X-Coralogix-Distribution: helm-otel-integration/0.0.224
    coralogix/resource_catalog:
      application_name: resource
      domain: app.staging.coralogix.net
      logs:
        headers:
          X-Coralogix-Distribution: helm-otel-integration/0.0.224
          x-coralogix-ingress: metadata-as-otlp-logs/v1
      private_key: ${CORALOGIX_PRIVATE_KEY}
      subsystem_name: catalog
      timeout: 30s
    debug: {}

  extensions:
    health_check:
      endpoint: ${env:MY_POD_IP}:13133
    pprof:
      endpoint: localhost:1777
    zpages:
      endpoint: localhost:55679

  processors:
    batch:
      send_batch_max_size: 2048
      send_batch_size: 1024
      timeout: 1s
    filter/workflow:
      error_mode: silent
      logs:
        log_record:
          - body["object"]["kind"] == "Pod" and not IsMatch(String(body["object"]["metadata"]["ownerReferences"]), ".*StatefulSet.*|.*ReplicaSet.*|.*Job.*|.*DaemonSet.*")
          - body["kind"] == "Pod" and not IsMatch(String(body["metadata"]["ownerReferences"]), ".*StatefulSet.*|.*ReplicaSet.*|.*Job.*|.*DaemonSet.*")
    k8sattributes:
      extract:
        metadata:
          - k8s.namespace.name
          - k8s.replicaset.name
          - k8s.statefulset.name
          - k8s.daemonset.name
          - k8s.cronjob.name
          - k8s.job.name
          - k8s.node.name
          - k8s.pod.name
      passthrough: false
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid
        - sources:
            - from: connection
        - sources:
            - from: resource_attribute
              name: k8s.job.name
    memory_limiter:
      check_interval: 5s
      limit_percentage: 80
      spike_limit_percentage: 25
    resource/metadata:
      attributes:
        - action: upsert
          key: k8s.cluster.name
          value: 'EKS-test-otel'
        - action: upsert
          key: cx.otel_integration.name
          value: coralogix-integration-helm
    resourcedetection/env:
      detectors:
        - system
        - env
      override: false
      system:
        resource_attributes:
          host.id:
            enabled: true
      timeout: 2s
    resourcedetection/region:
      detectors:
        - gcp
        - ec2
        - azure
        - eks
      eks:
        node_from_env_var: K8S_NODE_NAME
      override: true
      timeout: 2s
    resourcedetection/resource_catalog:
      azure:
        resource_attributes:
          azure.resourcegroup.name:
            enabled: false
          azure.vm.name:
            enabled: false
          azure.vm.scaleset.name:
            enabled: false
          azure.vm.size:
            enabled: false
          host.id:
            enabled: false
          host.name:
            enabled: false
      detectors:
        - eks
        - aks
        - gcp
        - ec2
        - azure
      ec2:
        resource_attributes:
          host.id:
            enabled: false
          host.image.id:
            enabled: false
          host.name:
            enabled: false
          host.type:
            enabled: false
      gcp:
        resource_attributes:
          host.id:
            enabled: false
          host.name:
            enabled: false
          host.type:
            enabled: false
          k8s.cluster.name:
            enabled: false
      override: true
      timeout: 2s
    transform/entity-event:
      error_mode: silent
      log_statements:
        - context: log
          statements:
            - set(attributes["otel.entity.interval"], Milliseconds(Duration("1h")))
    transform/k8s_attributes:
      log_statements:
        - context: resource
          statements:
            - set(attributes["k8s.deployment.name"], attributes["k8s.replicaset.name"])
            - replace_pattern(attributes["k8s.deployment.name"], "^(.*)-[0-9a-zA-Z]+$", "$$1") where attributes["k8s.replicaset.name"] != nil
            - delete_key(attributes, "k8s.replicaset.name")
      metric_statements:
        - context: resource
          statements:
            - set(attributes["k8s.deployment.name"], attributes["k8s.replicaset.name"])
            - replace_pattern(attributes["k8s.deployment.name"], "^(.*)-[0-9a-zA-Z]+$", "$$1") where attributes["k8s.replicaset.name"] != nil
            - delete_key(attributes, "k8s.replicaset.name")
      trace_statements:
        - context: resource
          statements:
            - set(attributes["k8s.deployment.name"], attributes["k8s.replicaset.name"])
            - replace_pattern(attributes["k8s.deployment.name"], "^(.*)-[0-9a-zA-Z]+$", "$$1") where attributes["k8s.replicaset.name"] != nil
            - delete_key(attributes, "k8s.replicaset.name")
    transform/semconv:
      error_mode: ignore
      trace_statements:
        - context: span
          statements:
            - set(attributes["http.method"], attributes["http.request.method"]) where attributes["http.request.method"] != nil

  receivers:
    k8sobjects/resource_catalog:
      objects:
        - group: ""
          mode: pull
          name: namespaces
        - group: ""
          mode: pull
          name: nodes
        - group: ""
          mode: pull
          name: persistentvolumeclaims
        - group: ""
          mode: pull
          name: persistentvolumes
        - group: ""
          mode: pull
          name: pods
        - group: ""
          mode: pull
          name: services
        - group: apps
          mode: pull
          name: daemonsets
        - group: apps
          mode: pull
          name: deployments
        - group: apps
          mode: pull
          name: replicasets
        - group: apps
          mode: pull
          name: statefulsets
        - group: autoscaling
          mode: pull
          name: horizontalpodautoscalers
        - group: batch
          mode: pull
          name: cronjobs
        - group: batch
          mode: pull
          name: jobs
        - group: extensions
          mode: pull
          name: ingresses
        - group: networking.k8s.io
          mode: pull
          name: ingresses
        - group: policy
          mode: pull
          name: poddisruptionbudgets
        - group: rbac.authorization.k8s.io
          mode: pull
          name: clusterrolebindings
        - group: rbac.authorization.k8s.io
          mode: pull
          name: clusterroles
        - group: rbac.authorization.k8s.io
          mode: pull
          name: rolebindings
        - group: rbac.authorization.k8s.io
          mode: pull
          name: roles
        - group: ""
          mode: watch
          name: namespaces
        - group: ""
          mode: watch
          name: nodes
        - group: ""
          mode: watch
          name: persistentvolumeclaims
        - group: ""
          mode: watch
          name: persistentvolumes
        - group: ""
          mode: watch
          name: pods
        - group: apps
          mode: watch
          name: daemonsets
        - group: apps
          mode: watch
          name: deployments
        - group: apps
          mode: watch
          name: replicasets
        - group: apps
          mode: watch
          name: statefulsets
        - group: autoscaling
          mode: watch
          name: horizontalpodautoscalers
        - group: batch
          mode: watch
          name: cronjobs
        - group: batch
          mode: watch
          name: jobs
        - group: extensions
          mode: watch
          name: ingresses
        - group: networking.k8s.io
          mode: watch
          name: ingresses
        - group: policy
          mode: watch
          name: poddisruptionbudgets
        - group: rbac.authorization.k8s.io
          mode: pull
          name: clusterrolebindings
        - group: rbac.authorization.k8s.io
          mode: pull
          name: clusterroles
        - group: rbac.authorization.k8s.io
          mode: pull
          name: rolebindings
        - group: rbac.authorization.k8s.io
          mode: pull
          name: roles
    k8sevents:
      auth_type: serviceAccount
      namespaces:
        - default
        - kube-system
        - kube-public
        - kube-node-lease
    kubeletstats:
      auth_type: serviceAccount
      collection_interval: 30s
      endpoint: https://${env:K8S_NODE_NAME}:10250
      insecure_skip_verify: true
      metric_groups:
        - container
        - pod
        - node
        - volume
    otlp:
      protocols:
        grpc:
          endpoint: ${env:MY_POD_IP}:4317
          max_recv_msg_size_mib: 20
        http:
          endpoint: ${env:MY_POD_IP}:4318
    prometheus:
      config:
        scrape_configs:
          - job_name: 'kubernetes-pods'
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                action: replace
                regex: ([^:]+)(?::\d+)?;(\d+)
                replacement: $1:$2
                target_label: __address__
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: kubernetes_namespace
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: kubernetes_pod_name
          - job_name: 'kubernetes-nodes'
            kubernetes_sd_configs:
              - role: node
            relabel_configs:
              - action: labelmap
                regex: __meta_kubernetes_node_label_(.+)
          - job_name: 'kubernetes-cadvisor'
            kubernetes_sd_configs:
              - role: node
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
              - action: labelmap
                regex: __meta_kubernetes_node_label_(.+)
              - target_label: __address__
                replacement: kubernetes.default.svc:443
              - source_labels: [__meta_kubernetes_node_name]
                regex: (.+)
                target_label: __metrics_path__
                replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

  service:
    extensions:
      - health_check
      - zpages
      - pprof
    pipelines:
      logs:
        exporters:
          - coralogix
        processors:
          - memory_limiter
          - resource/metadata
          - resourcedetection/region
          - resourcedetection/env
          - k8sattributes
          - transform/k8s_attributes
          - batch
        receivers:
          - otlp
      logs/kubernetes_events:
        exporters:
          - coralogix
        processors:
          - memory_limiter
          - resource/metadata
          - resourcedetection/region
          - resourcedetection/env
          - k8sattributes
          - transform/k8s_attributes
          - batch
        receivers:
          - k8sevents
      logs/resource_catalog:
        exporters:
          - coralogix/resource_catalog
        processors:
          - memory_limiter
          - resourcedetection/resource_catalog
          - transform/entity-event
          - filter/workflow
          - resource/metadata
          - batch
        receivers:
          - k8sobjects/resource_catalog
      metrics:
        exporters:
          - coralogix
        processors:
          - memory_limiter
          - resource/metadata
          - resourcedetection/region
          - resourcedetection/env
          - k8sattributes
          - transform/k8s_attributes
          - batch
        receivers:
          - kubeletstats
          - prometheus
          - otlp
      traces:
        exporters:
          - debug
          - coralogix
        processors:
          - memory_limiter
          - resource/metadata
          - resourcedetection/region
          - resourcedetection/env
          - k8sattributes
          - transform/k8s_attributes
          - transform/semconv
          - batch
        receivers:
          - otlp
    telemetry:
      logs:
        encoding: json
        level: 'info'
      resource:
        cx.agent.type: cluster-collector
        service.name: opentelemetry-collector
resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi
serviceAccount:
  create: true
  annotations: {}
extraEnvs:
  - name: K8S_NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName

